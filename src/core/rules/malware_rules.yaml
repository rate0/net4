---
# Malware Behavior Detection Rules
# These rules focus on detecting various malware behaviors and patterns

# Malware Command and Control Traffic
- id: "custom:malware:c2"
  name: "Malware Command and Control Traffic"
  description: "Detects common malware command and control communication patterns"
  severity: "high"
  conditions:
    protocol: {"in": ["TCP", "HTTP", "HTTPS"]}
    dst_port: {"in": [1234, 4444, 8080, 8443, 9001, 4443, 8888, 6666, 5555, 7777]}
    connection_interval_variance: {"lt": 0.1}
    connection_count: {"gt": 5}
  actions:
    set_threat_level: "malicious"
    add_entity_tag: ["malware", "c2", "command_and_control"]
    add_anomaly:
      type: "malware"
      subtype: "c2_traffic"
  category: "malware"
  tags: ["malware", "c2", "command_and_control"]
  enabled: true

# Data Exfiltration Pattern
- id: "custom:exfiltration:detection"
  name: "Data Exfiltration Detection"
  description: "Detects unusual data transfer patterns that may indicate data exfiltration"
  severity: "high"
  conditions:
    protocol: {"in": ["HTTP", "HTTPS", "FTP", "DNS"]}
    bytes_out: {"gt": 1000000}
    bytes_out_ratio: {"gt": 10}
  actions:
    set_threat_level: "suspicious"
    add_entity_tag: ["exfiltration", "data_theft"]
    add_anomaly:
      type: "data_theft"
      subtype: "exfiltration"
  category: "data_theft"
  tags: ["exfiltration", "data_theft", "data_loss"]
  enabled: true

# Ransomware Communication Pattern
- id: "custom:ransomware:detection"
  name: "Ransomware Communication Pattern"
  description: "Detects network patterns commonly associated with ransomware communication"
  severity: "critical"
  conditions:
    dst_port: {"in": [80, 443, 8080, 8443, 9001]}
    http_path: {"regex": ".*(bitcoin|payment|ransom|decrypt|pay|wallet).*"}
  actions:
    set_threat_level: "malicious"
    add_entity_tag: ["ransomware", "encryption", "malware"]
    add_anomaly:
      type: "malware"
      subtype: "ransomware"
  category: "malware"
  tags: ["ransomware", "encryption", "malware"]
  enabled: true

# Botnet Command and Control
- id: "custom:botnet:c2"
  name: "Botnet Command and Control"
  description: "Detects traffic patterns associated with botnet command and control channels"
  severity: "high"
  conditions:
    domain_entropy: {"gt": 0.8}
    connection_interval_variance: {"lt": 0.05}
    connection_count: {"gt": 5}
  actions:
    set_threat_level: "malicious"
    add_entity_tag: ["botnet", "c2", "malware"]
    add_anomaly:
      type: "botnet"
      subtype: "c2_traffic"
  category: "malware"
  tags: ["botnet", "c2", "malware"]
  enabled: true

# Suspicious PowerShell Commands
- id: "custom:powershell:malicious"
  name: "Suspicious PowerShell Commands"
  description: "Detects network traffic containing suspicious PowerShell command patterns"
  severity: "high"
  conditions:
    protocol: {"in": ["HTTP", "HTTPS"]}
    http_content: {"regex": ".*(powershell|Invoke-Expression|IEX|EncodedCommand|downloadstring|DownloadFile).*"}
  actions:
    set_threat_level: "suspicious"
    add_entity_tag: ["powershell", "script", "suspicious"]
    add_anomaly:
      type: "suspicious_activity"
      subtype: "powershell"
  category: "malicious_script"
  tags: ["powershell", "script", "suspicious"]
  enabled: true

# Phishing Site Communication
- id: "custom:phishing:detection"
  name: "Phishing Site Communication"
  description: "Detects communication with domains commonly associated with phishing"
  severity: "high"
  conditions:
    protocol: {"in": ["HTTP", "HTTPS"]}
    domain_age: {"lt": 30}
    domain_keywords: {"regex": ".*(login|account|secure|verify|bank|paypal|wallet|blockchain).*"}
  actions:
    set_threat_level: "malicious"
    add_entity_tag: ["phishing", "social_engineering"]
    add_anomaly:
      type: "phishing"
      subtype: "credential_theft"
  category: "social_engineering"
  tags: ["phishing", "credential_theft", "social_engineering"]
  enabled: true